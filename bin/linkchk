#!/usr/bin/python3
SVER = '1.0.6_dev1'
##############################################################################
# linkchk.py - SCA Pattern Link Verification Tool
# Copyright (C) 2022 SUSE LLC
#
# Description:  Validates META_LINK solution URLs to ensure they are valid.
#               Supports python and perl patterns with *.py and *.pl extensions.
# Modified:     2023 Jun 30
#
##############################################################################
#
#  This program is free software; you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation; version 2 of the License.
#
#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#
#  You should have received a copy of the GNU General Public License
#  along with this program; if not, see <http://www.gnu.org/licenses/>.
#
#  Authors/Contributors:
#     Jason Record <jason.record@suse.com>
#
##############################################################################

import sys
import os
import re
import getopt
import signal
import subprocess
import patdevel as pd
from datetime import timedelta
from timeit import default_timer as timer

##############################################################################
# Global Options
##############################################################################

recurse_directory = False
given_file = ''
pattern_list = []
c_ = {'current': 0, 'pat_total': 0, 'link_total': 0, 'nosolutions': 0, 'badconnection': 0, "badurl": 0, "bugid": 0, "ping": 0, "oldhosts": 0, "active_pattern": '', "active_link": ''}
invalid_links = {}
verbose = False
elapsed = -1
start = 0
end = 0

##############################################################################
# Functions
##############################################################################

def usage():
	"Displays usage information"
	print("Usage: linkchk.py [options] [filepath]")
	print()
	print("Options:")
	print("  -h, --help     Display this help")
	print("  -r, --recurse  Validate patterns recursively found in the directory structure")
	print("  -v, --verbose  Display verbose logging messages")
	print()

def signal_handler(sig, frame):
	print("\n\nAborting...\n")
	show_summary()
	sys.exit(1)

def show_summary():
	display = "{0:26} {1}"
	print("Summary")
	print("----------------------------------")
	print(display.format("Elsapsed Runtime", str(elapsed).split('.')[0]))
	print(display.format("Total Patterns Checked", c_['pat_total']))
	print(display.format("Total Links Evaluated", c_['link_total']))
	print(display.format("Patterns without Solutions", c_['nosolutions']))
	print(display.format("Invalid Connection Links", c_['badconnection']))
	print(display.format("Invalid URLs", c_['badurl']))
	print(display.format("Servers Down", c_['ping']))
	print(display.format("Invalid Bug Content", c_['bugid']))
	print(display.format("Old Host Domains", c_['oldhosts']))
	print(display.format("Active Pattern", c_['active_pattern']))
	print(display.format("Active Link", c_['active_link']))
	print()
	print("Invalid Links")
	print("----------------------------------")
	ldisplay = "  {0:25} {1}"
	if len(invalid_links) > 0:
		for pattern in invalid_links.keys():
			print(pattern)
			if invalid_links[pattern]['nosolutions']:
				print(ldisplay.format('! No Solutions', pattern))
			del invalid_links[pattern]['nosolutions']
			for key, value in invalid_links[pattern].items():
				print(ldisplay.format(value, key))
	else:
		print("None")
	print()

##############################################################################
# Main
##############################################################################

def main(argv):
	"main entry point"
	global SVER, pattern_list, recurse_directory, c_, invalid_links, verbose, elapsed, start, end
	start = timer()
	
	try:
		(optlist, args) = getopt.gnu_getopt(argv[1:], "hrv", ["help", "recurse", "verbose"])
	except getopt.GetoptError as exc:
		pd.title("SCA Pattern Link Verification Tool", SVER)
		print("Error:", exc, file=sys.stderr)
		sys.exit(2)
	for opt in optlist:
		if opt[0] in {"-h", "--help"}:
			pd.title("SCA Pattern Link Verification Tool", SVER)
			usage()
			sys.exit(0)
		elif opt[0] in {"-r", "--recurse"}:
			recurse_directory = True
		elif opt[0] in {"-v", "--verbose"}:
			verbose = True

	pd.title("SCA Pattern Link Verification Tool", SVER)
	print("Loading patterns...")
	given_file = ''
	if len(args) > 0:
		# TODO: support multiple files given on the command line to validate
		given_file = args[0]
		if os.path.isdir(given_file):
			path = os.path.abspath(given_file)
			pattern_list = pd.get_pattern_list(path, recurse_directory)
			if recurse_directory:
				print("Recursively Processing " + path)
			else:
				print("Processing " + path)
		elif os.path.isfile(given_file):
			given_file = os.path.abspath(given_file)
			print("Processing file " + given_file)
			pattern_list.append(given_file)
		else:
			print("Error: Invalid file or path - " + given_file)
			sys.exit(5)
	else:
		path = os.getcwd()
		if recurse_directory:
			print("Recursively Processing " + path)
		else:
			print("Processing " + path)
		pattern_list = pd.get_pattern_list(path, recurse_directory)

	c_['pat_total'] = len(pattern_list)
	vdisplay = "  {0:23} {1}"
	csize = len(str(c_['pat_total']))
	cdisplay = "{0:0" + str(csize) + "d}/{1} {2}"
	if not verbose:
		bar = pd.ProgressBar(" Validating links: ", c_['pat_total'])
	for pattern in pattern_list:
		c_['current'] += 1
		if verbose:
			print(cdisplay.format(c_['current'], c_['pat_total'], pattern))
		c_['active_pattern'] = pattern
		bad_urls = []
		url_list = pd.get_links_from_pattern_file(pattern)
		if( len(url_list) > 0 ):
			bad_urls, c_ = pd.validate_link_list(url_list, c_, verbose)
			if( len(bad_urls) > 0):
				invalid_links[pattern] = bad_urls
				if( len(bad_urls) == len(url_list) ):
					invalid_links[pattern]['nosolutions'] = True
					c_['nosolutions'] += 1
					status = "! No Solutions"
					if verbose:
						print(vdisplay.format(status, pattern))
				else:
					invalid_links[pattern]['nosolutions'] = False
		else:
			invalid_links[pattern] = {}
			invalid_links[pattern]['nosolutions'] = True
			c_['nosolutions'] += 1
			status = "! No Solution Links"
			if verbose:
				print(vdisplay.format(status, pattern))
		#print(invalid_links)
		
		if not verbose:
			bar.update(c_['current'])
	if not verbose:
		bar.finish()
	c_['active_pattern'] = "None" # Shows the active pattern file if linkchk is aborted
	c_['active_link'] = "None" # Shows the active link being checked if linkchk is aborted
	end = timer()
	elapsed = str(timedelta(seconds=end-start))
	if verbose:
		print()
	show_summary()
		
# Entry point
if __name__ == "__main__":
	signal.signal(signal.SIGINT, signal_handler)
	main(sys.argv)


